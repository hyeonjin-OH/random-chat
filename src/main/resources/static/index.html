<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta http-equiv="X-UA-Compatible" content="ie=edge" />
	<script src="https://code.jquery.com/jquery-latest.min.js"></script>
	<title>최초 로그인</title>
</head>
<body>
<div>
	<span>API키 </span>
	<input type="text" class = "api-key">
	<span>등록 캐릭터명</span>
	<input type="text" class="main-character-name">
	<button class="register-apikey">로스트아크 유저 등록</button>
</div>
<div>
	<span class = "api-result"> -</span>
</div>
<script>
	$(document).ready(function(){
		$(".register-apikey").on("click", function(e){
			e.preventDefault();

			var charName = $(".main-character-name").val();
			var apiKey = "bearer " + $(".api-key").val();
			var apiUrl = "https://developer-lostark.game.onstove.com/characters/"+charName+"/siblings"

			const promise = new Promise((resolve, reject)=>{
				$.ajax({
					url : apiUrl
					,method : "get"
					,beforeSend : function(xhr){
						xhr.setRequestHeader('accept', 'application/json');
						xhr.setRequestHeader('authorization', apiKey);
					}
					,success : function(data){
						
						if(data == null){
							$(".api-result").text("존재하지 않는 캐릭터명입니다.");
							reject("존재하지 않는 캐릭터명입니다.")
						}
						
						data.forEach(function(el, idx){
							if(el.CharacterName == charName){
								$(".api-result").text(JSON.stringify(data[idx]));
								resolve(data[idx])
							}
						});
					}
					,error : function(req, status, err){
						$(".api-result").text("유효하지 않은 API Key 입니다.");
						reject("유효하지 않은 API Key 입니다.")
					}
				});
			});
			
			promise.then((value)=>{
				const promise2 = new Promise((resolve, reject)=>{
					$.ajax({
						url: "/api/v1/register"
						,method: "post"
						,data:{
							id: null,
							apiKey: apiKey,
							nickName: value.CharacterName,
							mainCharacter: value.CharacterName
						}
						,datatype:"JSON"
						,success: function(data2){
							console.log("POST 반환 데이터: " + data2);
							resolve(data2)
						}
					});
				});
				return promise2;
			})
			.then((value)=>{
				redirUrl = "api/v1/prefer/"+value
				console.log("URL: "+redirUrl);
				$.ajax({
					url: redirUrl
					,method: "get"
					,success: function(data){
						console.log("GET 후 데이터: " + data)
						window.location.replace(":/randomchat/preferenceForm.html")
					}
					,error: function(req){
						console.log("GET 후 에러: " + req)
					}
				})
				
			});

		});
	});
</script>

</body>
</html>